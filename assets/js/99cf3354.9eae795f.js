"use strict";(self.webpackChunkcka_prep_2=self.webpackChunkcka_prep_2||[]).push([[1364],{3905:function(e,n,t){t.d(n,{Zo:function(){return u},kt:function(){return h}});var r=t(7294);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,r,i=function(e,n){if(null==e)return{};var t,r,i={},a=Object.keys(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var o=r.createContext({}),c=function(e){var n=r.useContext(o),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},u=function(e){var n=c(e.components);return r.createElement(o.Provider,{value:n},e.children)},p={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},d=r.forwardRef((function(e,n){var t=e.components,i=e.mdxType,a=e.originalType,o=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),d=c(t),h=i,m=d["".concat(o,".").concat(h)]||d[h]||p[h]||a;return t?r.createElement(m,l(l({ref:n},u),{},{components:t})):r.createElement(m,l({ref:n},u))}));function h(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var a=t.length,l=new Array(a);l[0]=d;var s={};for(var o in n)hasOwnProperty.call(n,o)&&(s[o]=n[o]);s.originalType=e,s.mdxType="string"==typeof e?e:i,l[1]=s;for(var c=2;c<a;c++)l[c]=t[c];return r.createElement.apply(null,l)}return r.createElement.apply(null,t)}d.displayName="MDXCreateElement"},2460:function(e,n,t){t.r(n),t.d(n,{frontMatter:function(){return s},contentTitle:function(){return o},metadata:function(){return c},toc:function(){return u},default:function(){return d}});var r=t(7462),i=t(3366),a=(t(7294),t(3905)),l=["components"],s={id:"chapter11",title:"Ingress"},o=void 0,c={unversionedId:"fundamentals/chapter11",id:"fundamentals/chapter11",title:"Ingress",description:"Course Reading",source:"@site/docs/fundamentals/chapter11.md",sourceDirName:"fundamentals",slug:"/fundamentals/chapter11",permalink:"/cka-prep/docs/fundamentals/chapter11",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/fundamentals/chapter11.md",tags:[],version:"current",frontMatter:{id:"chapter11",title:"Ingress"},sidebar:"tutorialSidebar",previous:{title:"Helm",permalink:"/cka-prep/docs/fundamentals/chapter10"},next:{title:"Scheduling",permalink:"/cka-prep/docs/fundamentals/chapter12"}},u=[{value:"Course Reading",id:"course-reading",children:[{value:"Learning objectives",id:"learning-objectives",children:[],level:3},{value:"Overview",id:"overview",children:[],level:3},{value:"Ingress controller",id:"ingress-controller",children:[],level:3},{value:"nginx",id:"nginx",children:[],level:3},{value:"Ingress API resources",id:"ingress-api-resources",children:[],level:3},{value:"Deploying the ingress controller",id:"deploying-the-ingress-controller",children:[],level:3},{value:"Creating an ingress rule",id:"creating-an-ingress-rule",children:[],level:3},{value:"Multiple ingress rules",id:"multiple-ingress-rules",children:[],level:3},{value:"Intelligent connected proxies",id:"intelligent-connected-proxies",children:[],level:3}],level:2},{value:"Lab Exercises",id:"lab-exercises",children:[{value:"Lab 11.1 - Service mesh",id:"lab-111---service-mesh",children:[],level:3}],level:2}],p={toc:u};function d(e){var n=e.components,s=(0,i.Z)(e,l);return(0,a.kt)("wrapper",(0,r.Z)({},p,s,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"course-reading"},"Course Reading"),(0,a.kt)("h3",{id:"learning-objectives"},"Learning objectives"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Discuss differences between an Ingress Controller vs a Service"),(0,a.kt)("li",{parentName:"ul"},"Learn about nginx and GCE Ingress Controllers"),(0,a.kt)("li",{parentName:"ul"},"Deploy and Ingress Controller"),(0,a.kt)("li",{parentName:"ul"},"Configure an Ingress Rule")),(0,a.kt)("h3",{id:"overview"},"Overview"),(0,a.kt)("p",null,"Earlier we learned about services and how to use them to connect containerized application in Kubernetes to outside the cluster. We can also used Ingress Controllers and Rules to do the same thing."),(0,a.kt)("p",null,"The difference between a service and ingress controllers lie in the efficiency.  Instead of many services, like ",(0,a.kt)("inlineCode",{parentName:"p"},"LoadBalancers"),", traffic can be routed based on the host or the path.  This lets us centralize traffic that could be going to many services to a single point."),(0,a.kt)("p",null,"Ingress controllers are different from other controllers as they are not managed by the ",(0,a.kt)("inlineCode",{parentName:"p"},"kube-controller-manager"),".  Multiple controller can be deployed with each using unique configuration.  A controller will use Ingress Rules to handle any traffic to and from outside the cluster."),(0,a.kt)("p",null,"There are many options for ingress controllers.  Some of them include GKE, nginx, Traefik, Contour, and Envoy.  Any tool that can be used as a reverse proxy should be able to work as an ingress controller, these agents will just need to consume rules and listen for the associated traffic. An Ingress Rule is an API object that we can create with ",(0,a.kt)("inlineCode",{parentName:"p"},"kubectl"),".  When the rule is created, it updates the ingress controller to allow traffic to from the outside to the internal service. Services can be left as ClusterIPs and then we can define how traffic gets routed to them via ingress rules."),(0,a.kt)("h3",{id:"ingress-controller"},"Ingress controller"),(0,a.kt)("p",null,"An ingress controller is a daemon running in a pod that watches the ",(0,a.kt)("inlineCode",{parentName:"p"},"/ingresses")," endpoint of the API server.  They are part of the ",(0,a.kt)("inlineCode",{parentName:"p"},"networking.k8s.io/v1")," group.  When new endpoints are created, the daemon uses the configured rules to allow the inbound traffic to the desired service, which is most often over HTTP."),(0,a.kt)("p",null,"You can deploy multiple ingress controllers. In that case, traffic should use annotations to select the correct controller to use.  A lack of matching annotations will cause every controller to try to satisfy the ingress traffic."),(0,a.kt)("h3",{id:"nginx"},"nginx"),(0,a.kt)("p",null,"Deploying nginx controllers is made simple through provided YAML files which can be found in the ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/kubernetes/ingress-nginx/blob/main/docs/deploy/index.md"},"Kubernetes Github")),(0,a.kt)("p",null,"Here you will also find configuration for several different platforms you can run a Kubernetes cluster on."),(0,a.kt)("p",null,"Like any ingress controller, there is come configuration required to deploy it properly. The deployment can be customized via configMaps, Annotations, or a custom template for more detailed use cases."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Easy integration with RBAC"),(0,a.kt)("li",{parentName:"ul"},"Uses annotation ",(0,a.kt)("inlineCode",{parentName:"li"},'kubernetes.io/ingress.class: "nginx"')),(0,a.kt)("li",{parentName:"ul"},"L7 traffic will require ",(0,a.kt)("inlineCode",{parentName:"li"},"proxy-real-ip-cidr")," setting"),(0,a.kt)("li",{parentName:"ul"},"Bypasses kube-proxy for session affinity"),(0,a.kt)("li",{parentName:"ul"},"Does not use ",(0,a.kt)("inlineCode",{parentName:"li"},"conntrack")," entries for iptables DNAT"),(0,a.kt)("li",{parentName:"ul"},"TLS requires host field to be defined")),(0,a.kt)("h3",{id:"ingress-api-resources"},"Ingress API resources"),(0,a.kt)("p",null,"A typical Ingress object looks like the this:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: ghost\nspec:\n  rules:\n  - host: ghost.192.168.99.100.nip.io\n    http:\n      paths:\n      - backend:\n          service:\n            name: ghost\n            port:\n              number: 2368\n        path: /\n        pathType: ImplementationSpecific\n")),(0,a.kt)("p",null,"Like all object, you can manage Ingress objects with ",(0,a.kt)("inlineCode",{parentName:"p"},"kubectl"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl get ingress\nkubectl delete ingress <ingress name>\nkubectl edit ingress <ingress name>\n")),(0,a.kt)("h3",{id:"deploying-the-ingress-controller"},"Deploying the ingress controller"),(0,a.kt)("p",null,"Deploying an ingress controller is as simple as running a ",(0,a.kt)("inlineCode",{parentName:"p"},"kubectl apply")," command.  You can find the source for a sample ingress from the link in the ",(0,a.kt)("a",{parentName:"p",href:"#nginx"},"nginx section"),". You could also install the ingress controller via Helm by following the sample's guide."),(0,a.kt)("p",null,"You can check all that was deployed with the sample by running ",(0,a.kt)("inlineCode",{parentName:"p"},"kubectl get pods,rc,svc")," to see what was deployed."),(0,a.kt)("h3",{id:"creating-an-ingress-rule"},"Creating an ingress rule"),(0,a.kt)("p",null,"Creating an ingress rule is fairly simple.  First let's assume we have a running pod and service."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl run ghost --image=ghost\nkubectl expose deployments ghost --port=2368\n")),(0,a.kt)("p",null,"Now you could apply the ingress rules we defined with the example in ",(0,a.kt)("a",{parentName:"p",href:"#ingress-api-resources"},"Ingress API resources"),"section. Once the ingress is created, the you should be able to access the application external to the cluster."),(0,a.kt)("h3",{id:"multiple-ingress-rules"},"Multiple ingress rules"),(0,a.kt)("p",null,"If you have multiple services, you could also define multiple rules in the ingress definition. To do this you would just add to the list defined under the ",(0,a.kt)("inlineCode",{parentName:"p"},"rules")," section of the manifest."),(0,a.kt)("h3",{id:"intelligent-connected-proxies"},"Intelligent connected proxies"),(0,a.kt)("p",null,"If you want to do things like service discovery, rate limiting, traffic management, or advanced metrics, you will likely need to implement a service mesh.  A service mesh consists of edge and embedded proxies that talk to each another to handle traffic based on rules from a control plane."),(0,a.kt)("p",null,"There are many options for service meshes, with some of the most popular being Envoy, Istio, and linkerd."),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:"center"},(0,a.kt)("img",{alt:"service mesh example",src:t(1778).Z,width:"685",height:"751"})))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},(0,a.kt)("b",null,"Example of a service mesh from Istio"))))),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Envoy")," - a modular and extensible proxy. It is popular due to the open construction, modularity, and it's dedication to remain unmonetized. It is common to use Envoy for as a data plane under near other tools in a service mesh."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Istio")," - a set of tools that leverages Envoy's proxies to construct a multi-component control plane.  It is intended to be platform independent."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"linkerd")," - service mesh built for ease and speed of deployment and for being ultralight.")),(0,a.kt)("h2",{id:"lab-exercises"},"Lab Exercises"),(0,a.kt)("h3",{id:"lab-111---service-mesh"},"Lab 11.1 - Service mesh"),(0,a.kt)("p",null,"First we will install linkerd.  Make sure all the installation steps are successful by reviewing the output of each command."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'curl -sL run.linkerd.io/install | sh\nexport PATH=$PATH:/home/ubuntu/.linkerd2/bin\necho "export PATH=$PATH:/home/ubuntu/.linkerd2/bin" >> $HOME/.bashrc\nlinkerd check --pre\nlinkerd install --crds | kubectl apply -f -\nlinkerd install | kubectl apply -f -\nlinkerd check\nlinkerd viz install | kubectl apply -f -\nlinkerd viz check\nlinkerd viz dashboard &\n')))}d.isMDXComponent=!0},1778:function(e,n,t){n.Z=t.p+"assets/images/ch11-istio-service-mesh-2d5cbc6c88e9b22aa0e449102ae5f6c8.png"}}]);