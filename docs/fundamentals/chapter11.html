<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<title data-react-helmet="true">Ingress | CKA Prep</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://your-docusaurus-test-site.com/cka-prep/docs/fundamentals/chapter11"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Ingress | CKA Prep"><meta data-react-helmet="true" name="description" content="Course Reading"><meta data-react-helmet="true" property="og:description" content="Course Reading"><link data-react-helmet="true" rel="icon" href="/cka-prep/img/k8s.png"><link data-react-helmet="true" rel="canonical" href="https://your-docusaurus-test-site.com/cka-prep/docs/fundamentals/chapter11"><link data-react-helmet="true" rel="alternate" href="https://your-docusaurus-test-site.com/cka-prep/docs/fundamentals/chapter11" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://your-docusaurus-test-site.com/cka-prep/docs/fundamentals/chapter11" hreflang="x-default"><link rel="stylesheet" href="/cka-prep/assets/css/styles.e68b4784.css">
<link rel="preload" href="/cka-prep/assets/js/runtime~main.0a33b008.js" as="script">
<link rel="preload" href="/cka-prep/assets/js/main.5dd4e585.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/cka-prep/"><div class="navbar__logo"><img src="/cka-prep/img/kubernetes-icon.svg" alt="My Site Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/cka-prep/img/kubernetes-icon.svg" alt="My Site Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">CKA Prep</b></a><a class="navbar__item navbar__link navbar__link--active" href="/cka-prep/docs/intro">Notes</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/andrewdaoust/cka-prep" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/cka-prep/docs/intro">Kubernetes Resources</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active hasHref_VCh3" aria-current="page" href="/cka-prep/docs/fundamentals">Kubernetes Fundamentals</a><button aria-label="Toggle the collapsible sidebar category &#x27;Kubernetes Fundamentals&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cka-prep/docs/fundamentals/chapter01">Course Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cka-prep/docs/fundamentals/chapter02">Basics of Kubernetes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cka-prep/docs/fundamentals/chapter03">Installation and Configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cka-prep/docs/fundamentals/chapter04">Kubernetes Architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cka-prep/docs/fundamentals/chapter05">APIs and Access</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cka-prep/docs/fundamentals/chapter06">API Objects</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cka-prep/docs/fundamentals/chapter07">Managing State with Deployments</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cka-prep/docs/fundamentals/chapter08">Volumes and Data</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cka-prep/docs/fundamentals/chapter09">Services</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cka-prep/docs/fundamentals/chapter10">Helm</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/cka-prep/docs/fundamentals/chapter11">Ingress</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cka-prep/docs/fundamentals/chapter12">Scheduling</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cka-prep/docs/fundamentals/chapter13">Logging and Troubleshooting</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cka-prep/docs/fundamentals/chapter14">Custom Resource Definitions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cka-prep/docs/fundamentals/chapter15">Security</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cka-prep/docs/fundamentals/chapter16">High Availability</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cka-prep/docs/fundamentals/chapter17">Exam Domain Review</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cka-prep/docs/fundamentals/follow-up">Follow-up Items</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/cka-prep/docs/kubectl/setup">kubectl</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/cka-prep/docs/hard-way/about">Kubernetes the Hard Way</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/cka-prep/docs/linux">Linux</a><button aria-label="Toggle the collapsible sidebar category &#x27;Linux&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/cka-prep/docs/misc">Miscellaneous Topics</a><button aria-label="Toggle the collapsible sidebar category &#x27;Miscellaneous Topics&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Ingress</h1></header><h2 id="course-reading">Course Reading</h2><h3 id="learning-objectives">Learning objectives</h3><ul><li>Discuss differences between an Ingress Controller vs a Service</li><li>Learn about nginx and GCE Ingress Controllers</li><li>Deploy and Ingress Controller</li><li>Configure an Ingress Rule</li></ul><h3 id="overview">Overview</h3><p>Earlier we learned about services and how to use them to connect containerized application in Kubernetes to outside the cluster. We can also used Ingress Controllers and Rules to do the same thing.</p><p>The difference between a service and ingress controllers lie in the efficiency.  Instead of many services, like <code>LoadBalancers</code>, traffic can be routed based on the host or the path.  This lets us centralize traffic that could be going to many services to a single point.</p><p>Ingress controllers are different from other controllers as they are not managed by the <code>kube-controller-manager</code>.  Multiple controller can be deployed with each using unique configuration.  A controller will use Ingress Rules to handle any traffic to and from outside the cluster.</p><p>There are many options for ingress controllers.  Some of them include GKE, nginx, Traefik, Contour, and Envoy.  Any tool that can be used as a reverse proxy should be able to work as an ingress controller, these agents will just need to consume rules and listen for the associated traffic. An Ingress Rule is an API object that we can create with <code>kubectl</code>.  When the rule is created, it updates the ingress controller to allow traffic to from the outside to the internal service. Services can be left as ClusterIPs and then we can define how traffic gets routed to them via ingress rules.</p><h3 id="ingress-controller">Ingress controller</h3><p>An ingress controller is a daemon running in a pod that watches the <code>/ingresses</code> endpoint of the API server.  They are part of the <code>networking.k8s.io/v1</code> group.  When new endpoints are created, the daemon uses the configured rules to allow the inbound traffic to the desired service, which is most often over HTTP.</p><p>You can deploy multiple ingress controllers. In that case, traffic should use annotations to select the correct controller to use.  A lack of matching annotations will cause every controller to try to satisfy the ingress traffic.</p><h3 id="nginx">nginx</h3><p>Deploying nginx controllers is made simple through provided YAML files which can be found in the <a href="https://github.com/kubernetes/ingress-nginx/blob/main/docs/deploy/index.md">Kubernetes Github</a></p><p>Here you will also find configuration for several different platforms you can run a Kubernetes cluster on.</p><p>Like any ingress controller, there is come configuration required to deploy it properly. The deployment can be customized via configMaps, Annotations, or a custom template for more detailed use cases.</p><ul><li>Easy integration with RBAC</li><li>Uses annotation <code>kubernetes.io/ingress.class: &quot;nginx&quot;</code></li><li>L7 traffic will require <code>proxy-real-ip-cidr</code> setting</li><li>Bypasses kube-proxy for session affinity</li><li>Does not use <code>conntrack</code> entries for iptables DNAT</li><li>TLS requires host field to be defined</li></ul><h3 id="ingress-api-resources">Ingress API resources</h3><p>A typical Ingress object looks like the this:</p><pre><code class="language-yaml">apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ghost
spec:
  rules:
  - host: ghost.192.168.99.100.nip.io
    http:
      paths:
      - backend:
          service:
            name: ghost
            port:
              number: 2368
        path: /
        pathType: ImplementationSpecific
</code></pre><p>Like all object, you can manage Ingress objects with <code>kubectl</code>.</p><div style="border-radius:10px"><div style="display:flex;background-color:#edeeef;padding:6px;border-top-left-radius:10px;border-top-right-radius:10px"><div style="background-color:#FF605C;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#FFBD44;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#00CA4E;border-radius:100%;width:10px;height:10px;margin:3px"></div></div><div style="background-color:black;color:#00ff01;font-family:monospace;border-bottom-left-radius:10px;border-bottom-right-radius:10px;padding-top:5px;padding-bottom:5px;padding-left:4px;margin-bottom:10px"><p style="margin:0px;padding:2px">~:$ kubectl get ingress</p><p style="margin:0px;padding:2px">~:$ kubectl delete ingress &lt;ingress name&gt;</p><p style="margin:0px;padding:2px">~:$ kubectl edit ingress &lt;ingress name&gt;</p></div></div><h3 id="deploying-the-ingress-controller">Deploying the ingress controller</h3><p>Deploying an ingress controller is as simple as running a <code>kubectl apply</code> command.  You can find the source for a sample ingress from the link in the <a href="#nginx">nginx section</a>. You could also install the ingress controller via Helm by following the sample&#x27;s guide.</p><p>You can check all that was deployed with the sample by running <code>kubectl get pods,rc,svc</code> to see what was deployed.</p><h3 id="creating-an-ingress-rule">Creating an ingress rule</h3><p>Creating an ingress rule is fairly simple.  First let&#x27;s assume we have a running pod and service.</p><div style="border-radius:10px"><div style="display:flex;background-color:#edeeef;padding:6px;border-top-left-radius:10px;border-top-right-radius:10px"><div style="background-color:#FF605C;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#FFBD44;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#00CA4E;border-radius:100%;width:10px;height:10px;margin:3px"></div></div><div style="background-color:black;color:#00ff01;font-family:monospace;border-bottom-left-radius:10px;border-bottom-right-radius:10px;padding-top:5px;padding-bottom:5px;padding-left:4px;margin-bottom:10px"><p style="margin:0px;padding:2px">~:$ kubectl run ghost --image=ghost</p><p style="margin:0px;padding:2px">~:$ kubectl expose deployments ghost --port=2368</p></div></div><p>Now you could apply the ingress rules we defined with the example in <a href="#ingress-api-resources">Ingress API resources</a>section. Once the ingress is created, the you should be able to access the application external to the cluster.</p><h3 id="multiple-ingress-rules">Multiple ingress rules</h3><p>If you have multiple services, you could also define multiple rules in the ingress definition. To do this you would just add to the list defined under the <code>rules</code> section of the manifest.</p><h3 id="intelligent-connected-proxies">Intelligent connected proxies</h3><p>If you want to do things like service discovery, rate limiting, traffic management, or advanced metrics, you will likely need to implement a service mesh.  A service mesh consists of edge and embedded proxies that talk to each another to handle traffic based on rules from a control plane.</p><p>There are many options for service meshes, with some of the most popular being Envoy, Istio, and linkerd.</p><table><thead><tr><th align="center"><img alt="service mesh example" src="/cka-prep/assets/images/ch11-istio-service-mesh-2d5cbc6c88e9b22aa0e449102ae5f6c8.png" width="685" height="751"></th></tr></thead><tbody><tr><td align="center"><b>Example of a service mesh from Istio</b></td></tr></tbody></table><ul><li><strong>Envoy</strong> - a modular and extensible proxy. It is popular due to the open construction, modularity, and it&#x27;s dedication to remain unmonetized. It is common to use Envoy for as a data plane under near other tools in a service mesh.</li><li><strong>Istio</strong> - a set of tools that leverages Envoy&#x27;s proxies to construct a multi-component control plane.  It is intended to be platform independent.</li><li><strong>linkerd</strong> - service mesh built for ease and speed of deployment and for being ultralight.</li></ul><h2 id="lab-exercises">Lab Exercises</h2><h3 id="lab-111---service-mesh">Lab 11.1 - Service mesh</h3><p>First we will install linkerd.  Make sure all the installation steps are successful by reviewing the output of each command.</p><div style="border-radius:10px"><div style="display:flex;background-color:#edeeef;padding:6px;border-top-left-radius:10px;border-top-right-radius:10px"><div style="background-color:#FF605C;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#FFBD44;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#00CA4E;border-radius:100%;width:10px;height:10px;margin:3px"></div></div><div style="background-color:black;color:#00ff01;font-family:monospace;border-bottom-left-radius:10px;border-bottom-right-radius:10px;padding-top:5px;padding-bottom:5px;padding-left:4px;margin-bottom:10px"><p style="margin:0px;padding:2px">~:$ curl -sL run.linkerd.io/install | sh</p><p style="margin:0px;padding:2px">~:$ export PATH=$PATH:/home/ubuntu/.linkerd2/bin</p><p style="margin:0px;padding:2px">~:$ echo &quot;export PATH=$PATH:/home/ubuntu/.linkerd2/bin&quot; &gt;&gt; $HOME/.bashrc</p><p style="margin:0px;padding:2px">~:$ linkerd check --pre</p><p style="margin:0px;padding:2px">~:$ linkerd install --crds | kubectl apply -f -</p><p style="margin:0px;padding:2px">~:$ linkerd install --set proxyInit.runAsRoot=true | kubectl apply -f -</p><p style="margin:0px;padding:2px">~:$ linkerd check</p><p style="margin:0px;padding:2px">~:$ linkerd viz install | kubectl apply -f -</p><p style="margin:0px;padding:2px">~:$ linkerd viz check</p><p style="margin:0px;padding:2px">~:$ linkerd viz dashboard &amp;</p></div></div><p>The GUI for linkerd is enabled on localhost by default. We need to edit the <code>web</code> deployment and service to allow for access of the GUI outside the cluster since we are running in a cloud provider.</p><p>For the deployment, in the container args, find the <code>enforce-host</code> line and remove the value after the <code>=</code>.</p><p>On the service, add the <code>nodePort</code> to the <code>http</code> port with some high valued port number that is easy to remember and set the service <code>type</code> to a <code>NodePort</code>.</p><div style="border-radius:10px"><div style="display:flex;background-color:#edeeef;padding:6px;border-top-left-radius:10px;border-top-right-radius:10px"><div style="background-color:#FF605C;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#FFBD44;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#00CA4E;border-radius:100%;width:10px;height:10px;margin:3px"></div></div><div style="background-color:black;color:#00ff01;font-family:monospace;border-bottom-left-radius:10px;border-bottom-right-radius:10px;padding-top:5px;padding-bottom:5px;padding-left:4px;margin-bottom:10px"><p style="margin:0px;padding:2px">~:$ kubectl -n linkerd-viz edit deploy web</p><p style="margin:0px;padding:2px">~:$ kubectl -n linkerd-viz edit svc web</p></div></div><p>Test access to your public IP.</p><div style="border-radius:10px"><div style="display:flex;background-color:#edeeef;padding:6px;border-top-left-radius:10px;border-top-right-radius:10px"><div style="background-color:#FF605C;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#FFBD44;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#00CA4E;border-radius:100%;width:10px;height:10px;margin:3px"></div></div><div style="background-color:black;color:#00ff01;font-family:monospace;border-bottom-left-radius:10px;border-bottom-right-radius:10px;padding-top:5px;padding-bottom:5px;padding-left:4px;margin-bottom:10px"><p style="margin:0px;padding:2px">~:$ curl ifconfig.io</p></div></div><p>Now use the public IP and the NodePort number you set to access the GUI in a browser on your local machine.</p><p>With the GUI accessible externally we can now add the annotations we need for linkerd to watch those objects. linkerd can do this for us by piping <code>kubectl</code> commands to <code>linkerd</code> and then back to <code>kubectl</code>. You should see an error about the creation of the object but it should work fine. The view the GUI again and you should see the <code>accounting</code> namespaces are meshed.</p><p>However, let&#x27;s first create a deployment and expose it with a service to use in the service mesh.</p><div style="border-radius:10px"><div style="display:flex;background-color:#edeeef;padding:6px;border-top-left-radius:10px;border-top-right-radius:10px"><div style="background-color:#FF605C;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#FFBD44;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#00CA4E;border-radius:100%;width:10px;height:10px;margin:3px"></div></div><div style="background-color:black;color:#00ff01;font-family:monospace;border-bottom-left-radius:10px;border-bottom-right-radius:10px;padding-top:5px;padding-bottom:5px;padding-left:4px;margin-bottom:10px"><p style="margin:0px;padding:2px">~:$ kubectl -n accounting create deploy nginx --image=nginx</p><p style="margin:0px;padding:2px">~:$ kubectl -n accounting expose deployment nginx --type=ClusterIP --port=80</p></div></div><p>Then we will inject the annotations.</p><div style="border-radius:10px"><div style="display:flex;background-color:#edeeef;padding:6px;border-top-left-radius:10px;border-top-right-radius:10px"><div style="background-color:#FF605C;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#FFBD44;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#00CA4E;border-radius:100%;width:10px;height:10px;margin:3px"></div></div><div style="background-color:black;color:#00ff01;font-family:monospace;border-bottom-left-radius:10px;border-bottom-right-radius:10px;padding-top:5px;padding-bottom:5px;padding-left:4px;margin-bottom:10px"><p style="margin:0px;padding:2px">~:$ kubectl -n accounting get deploy nginx -o yaml | linkerd inject - | kubectl apply -f -</p></div></div><p>Then we will want to generate some traffic to pods and watch that traffic in the UI. We&#x27;ll use the <code>nginx</code> service we just created.</p><div style="border-radius:10px"><div style="display:flex;background-color:#edeeef;padding:6px;border-top-left-radius:10px;border-top-right-radius:10px"><div style="background-color:#FF605C;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#FFBD44;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#00CA4E;border-radius:100%;width:10px;height:10px;margin:3px"></div></div><div style="background-color:black;color:#00ff01;font-family:monospace;border-bottom-left-radius:10px;border-bottom-right-radius:10px;padding-top:5px;padding-bottom:5px;padding-left:4px;margin-bottom:10px"><p style="margin:0px;padding:2px">~:$ kubectl -n accounting get svc</p><p style="margin:0px;padding:2px">~:$ curl &lt;nginx ClusterIP&gt;</p></div></div><p>In the UI you should see some HTTP metrics in the accounting namespace. Now let&#x27;s scale up the <code>nginx</code> deployment to 5 replicas and then generate traffic to them.</p><div style="border-radius:10px"><div style="display:flex;background-color:#edeeef;padding:6px;border-top-left-radius:10px;border-top-right-radius:10px"><div style="background-color:#FF605C;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#FFBD44;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#00CA4E;border-radius:100%;width:10px;height:10px;margin:3px"></div></div><div style="background-color:black;color:#00ff01;font-family:monospace;border-bottom-left-radius:10px;border-bottom-right-radius:10px;padding-top:5px;padding-bottom:5px;padding-left:4px;margin-bottom:10px"><p style="margin:0px;padding:2px">~:$ kubectl -n accounting scale deploy nginx --replicas=5</p><p style="margin:0px;padding:2px">~:$ curl &lt;nginx ClusterIP&gt;</p><p style="margin:0px;padding:2px">~:$ curl &lt;nginx ClusterIP&gt;</p><p style="margin:0px;padding:2px">~:$ curl &lt;nginx ClusterIP&gt;</p><p style="margin:0px;padding:2px">~:$ curl &lt;nginx ClusterIP&gt;</p><p style="margin:0px;padding:2px">~:$ curl &lt;nginx ClusterIP&gt;</p><p style="margin:0px;padding:2px">~:$ curl &lt;nginx ClusterIP&gt;</p></div></div><p>In the UI we should see 5 replicas being meshed in the namespace as well as some other statistics.</p><h3 id="lab-112---ingress-controller">Lab 11.2 - Ingress controller</h3><p>Now we will use Helm to install an ingress controller.</p><p>First, we will want to create two deployments, one called <code>web-one</code> running httpd, and another called <code>web-two</code> running nginx.</p><div style="border-radius:10px"><div style="display:flex;background-color:#edeeef;padding:6px;border-top-left-radius:10px;border-top-right-radius:10px"><div style="background-color:#FF605C;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#FFBD44;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#00CA4E;border-radius:100%;width:10px;height:10px;margin:3px"></div></div><div style="background-color:black;color:#00ff01;font-family:monospace;border-bottom-left-radius:10px;border-bottom-right-radius:10px;padding-top:5px;padding-bottom:5px;padding-left:4px;margin-bottom:10px"><p style="margin:0px;padding:2px">~:$ kubectl create deployment web-one --image=httpd</p><p style="margin:0px;padding:2px">~:$ kubectl create deployment web-two --image=nginx</p><p style="margin:0px;padding:2px">~:$ kubectl expose deployment web-one --type=ClusterIP --port=80</p><p style="margin:0px;padding:2px">~:$ kubectl expose deployment web-two --type=ClusterIP --port=80</p></div></div><p>Linkerd does not have a bundled ingress controller so we need to install on the cluster ourselves to manage traffic. We will use a Helm chart to do this. Let&#x27;s search for <code>ingress</code> with Helm and then install the popular nginx ingress controller.</p><div style="border-radius:10px"><div style="display:flex;background-color:#edeeef;padding:6px;border-top-left-radius:10px;border-top-right-radius:10px"><div style="background-color:#FF605C;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#FFBD44;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#00CA4E;border-radius:100%;width:10px;height:10px;margin:3px"></div></div><div style="background-color:black;color:#00ff01;font-family:monospace;border-bottom-left-radius:10px;border-bottom-right-radius:10px;padding-top:5px;padding-bottom:5px;padding-left:4px;margin-bottom:10px"><p style="margin:0px;padding:2px">~:$ helm search hub ingress</p><p style="margin:0px;padding:2px">~:$ helm repo add ingress-nginx http://kubernetes.github.io/ingress-nginx</p><p style="margin:0px;padding:2px">~:$ helm repo update</p></div></div><p>Now we will download the chart, and update the <code>values.yaml</code> so that the ingress controller uses a DaemonSet instead of a Deployment by changing the <code>kind</code> field.</p><div style="border-radius:10px"><div style="display:flex;background-color:#edeeef;padding:6px;border-top-left-radius:10px;border-top-right-radius:10px"><div style="background-color:#FF605C;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#FFBD44;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#00CA4E;border-radius:100%;width:10px;height:10px;margin:3px"></div></div><div style="background-color:black;color:#00ff01;font-family:monospace;border-bottom-left-radius:10px;border-bottom-right-radius:10px;padding-top:5px;padding-bottom:5px;padding-left:4px;margin-bottom:10px"><p style="margin:0px;padding:2px">~:$ helm fetch ingress-nginx/ingress-nginx --untar</p><p style="margin:0px;padding:2px">~:$ cd ingress-nginx</p><p style="margin:0px;padding:2px">~/ingress-nginx:$ vim values.yaml</p></div></div><p>Then, we will install the controller. Then watch for the service to come up. When getting the ingress, you should see no resource available yet. We will create that later.</p><div style="border-radius:10px"><div style="display:flex;background-color:#edeeef;padding:6px;border-top-left-radius:10px;border-top-right-radius:10px"><div style="background-color:#FF605C;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#FFBD44;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#00CA4E;border-radius:100%;width:10px;height:10px;margin:3px"></div></div><div style="background-color:black;color:#00ff01;font-family:monospace;border-bottom-left-radius:10px;border-bottom-right-radius:10px;padding-top:5px;padding-bottom:5px;padding-left:4px;margin-bottom:10px"><p style="margin:0px;padding:2px">~/ingress-nginx:$ helm install myingress .</p><p style="margin:0px;padding:2px">~/ingress-nginx:$ cd ..</p><p style="margin:0px;padding:2px">~:$ kubectl get ingress --all-namespaces</p><p style="margin:0px;padding:2px">~:$ kubectl get services -o wide myingress-ingress-nginx-controller</p><p style="margin:0px;padding:2px">~:$ kubectl get pod --all-namespaces | grep nginx</p></div></div><p>Once the ingress controller is up and running, we can set up the ingress rules.</p><div style="border-radius:10px"><div style="display:flex;background-color:#edeeef;padding:6px;border-top-left-radius:10px;border-top-right-radius:10px"><div style="background-color:#FF605C;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#FFBD44;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#00CA4E;border-radius:100%;width:10px;height:10px;margin:3px"></div></div><div style="background-color:black;color:#00ff01;font-family:monospace;border-bottom-left-radius:10px;border-bottom-right-radius:10px;padding-top:5px;padding-bottom:5px;padding-left:4px;margin-bottom:10px"><p style="margin:0px;padding:2px">~:$ vim ingress.yaml</p></div></div><pre><code class="language-yaml">apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-test
  annotations:
    kubernetes.io/ingress.class: nginx
  namespace: default
spec:
  rules:
  - host: www.external.com
    http:
      paths:
      - backend:
          service:
            name: web-one
            port:
              number: 80
        path: /
        pathType: ImplementationSpecific
status:
  loadBalancer: {}
</code></pre><p>And now with the ingress rule defined, we can create it and verify it is working.</p><div style="border-radius:10px"><div style="display:flex;background-color:#edeeef;padding:6px;border-top-left-radius:10px;border-top-right-radius:10px"><div style="background-color:#FF605C;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#FFBD44;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#00CA4E;border-radius:100%;width:10px;height:10px;margin:3px"></div></div><div style="background-color:black;color:#00ff01;font-family:monospace;border-bottom-left-radius:10px;border-bottom-right-radius:10px;padding-top:5px;padding-bottom:5px;padding-left:4px;margin-bottom:10px"><p style="margin:0px;padding:2px">~:$ kubectl create -f ingress.yaml</p><p style="margin:0px;padding:2px">~:$ kubectl get ingress</p><p style="margin:0px;padding:2px">~:$ kubectl get pod -o wide | grep myingress</p><p style="margin:0px;padding:2px">~:$ curl &lt;Pod IP&gt;</p></div></div><p>At this point you should see you got a 404 error response from your curl.  Now let&#x27;s check the LoadBalancer service (don&#x27;t use the admission controller that you will see).</p><div style="border-radius:10px"><div style="display:flex;background-color:#edeeef;padding:6px;border-top-left-radius:10px;border-top-right-radius:10px"><div style="background-color:#FF605C;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#FFBD44;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#00CA4E;border-radius:100%;width:10px;height:10px;margin:3px"></div></div><div style="background-color:black;color:#00ff01;font-family:monospace;border-bottom-left-radius:10px;border-bottom-right-radius:10px;padding-top:5px;padding-bottom:5px;padding-left:4px;margin-bottom:10px"><p style="margin:0px;padding:2px">~:$ kubectl get svc | grep ingress</p><p style="margin:0px;padding:2px">~:$ curl &lt;myingress-ingress-nginx-controller service IP&gt;</p></div></div><p>Again you should see that you are getting a 404 error. Let&#x27;s try it again, this time passing a header matching the URL to one of the services we created earlier.  If it works you should see a default nginx/httpd server page.</p><div style="border-radius:10px"><div style="display:flex;background-color:#edeeef;padding:6px;border-top-left-radius:10px;border-top-right-radius:10px"><div style="background-color:#FF605C;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#FFBD44;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#00CA4E;border-radius:100%;width:10px;height:10px;margin:3px"></div></div><div style="background-color:black;color:#00ff01;font-family:monospace;border-bottom-left-radius:10px;border-bottom-right-radius:10px;padding-top:5px;padding-bottom:5px;padding-left:4px;margin-bottom:10px"><p style="margin:0px;padding:2px">~:$ curl -H &quot;Host: www.external.com&quot; http://&lt;myingress-ingress-nginx-controller service IP&gt;</p></div></div><p>With that working we can then add the annotations for linkerd. Again, you will see some warnings but it should work.</p><div style="border-radius:10px"><div style="display:flex;background-color:#edeeef;padding:6px;border-top-left-radius:10px;border-top-right-radius:10px"><div style="background-color:#FF605C;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#FFBD44;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#00CA4E;border-radius:100%;width:10px;height:10px;margin:3px"></div></div><div style="background-color:black;color:#00ff01;font-family:monospace;border-bottom-left-radius:10px;border-bottom-right-radius:10px;padding-top:5px;padding-bottom:5px;padding-left:4px;margin-bottom:10px"><p style="margin:0px;padding:2px">~:$ kubectl get ds myingress-ingress-nginx-controller -o yaml | linkerd inject --ingress - | kubectl apply -f -</p></div></div><p>Now let&#x27;s update the ingress with a new rule. Edit the ingress<code>and all the following to</code>spec.rules` field.</p><div style="border-radius:10px"><div style="display:flex;background-color:#edeeef;padding:6px;border-top-left-radius:10px;border-top-right-radius:10px"><div style="background-color:#FF605C;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#FFBD44;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#00CA4E;border-radius:100%;width:10px;height:10px;margin:3px"></div></div><div style="background-color:black;color:#00ff01;font-family:monospace;border-bottom-left-radius:10px;border-bottom-right-radius:10px;padding-top:5px;padding-bottom:5px;padding-left:4px;margin-bottom:10px"><p style="margin:0px;padding:2px">~:$ kubectl edit ingress ingress-test</p></div></div><pre><code class="language-yaml">  - host: internal.org
    http:
      paths:
      - backend:
          service:
            name: web-one
            port:
              number: 80
        path: /
        pathType: ImplementationSpec
</code></pre><p>Now test the ingress rule by <code>curl</code>ing with the new header.</p><div style="border-radius:10px"><div style="display:flex;background-color:#edeeef;padding:6px;border-top-left-radius:10px;border-top-right-radius:10px"><div style="background-color:#FF605C;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#FFBD44;border-radius:100%;width:10px;height:10px;margin:3px"></div><div style="background-color:#00CA4E;border-radius:100%;width:10px;height:10px;margin:3px"></div></div><div style="background-color:black;color:#00ff01;font-family:monospace;border-bottom-left-radius:10px;border-bottom-right-radius:10px;padding-top:5px;padding-bottom:5px;padding-left:4px;margin-bottom:10px"><p style="margin:0px;padding:2px">~:$ curl -H &quot;Host: internal.org&quot; http://&lt;myingress-ingress-nginx-controller service IP&gt;</p></div></div><p>You should see the nginx default page.</p><h2 id="knowledge-check">Knowledge check</h2><ul><li>According to the documentation, Kubernetes currently support <strong>3</strong> ingress controllers (AWS, GCE, and nginx)</li><li>The main reason to use an ingress controller is for <strong>efficiency</strong></li><li>Both L4 and l&amp; traffic can be configured</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/fundamentals/chapter11.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/cka-prep/docs/fundamentals/chapter10"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Helm</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/cka-prep/docs/fundamentals/chapter12"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Scheduling</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#course-reading" class="table-of-contents__link toc-highlight">Course Reading</a><ul><li><a href="#learning-objectives" class="table-of-contents__link toc-highlight">Learning objectives</a></li><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#ingress-controller" class="table-of-contents__link toc-highlight">Ingress controller</a></li><li><a href="#nginx" class="table-of-contents__link toc-highlight">nginx</a></li><li><a href="#ingress-api-resources" class="table-of-contents__link toc-highlight">Ingress API resources</a></li><li><a href="#deploying-the-ingress-controller" class="table-of-contents__link toc-highlight">Deploying the ingress controller</a></li><li><a href="#creating-an-ingress-rule" class="table-of-contents__link toc-highlight">Creating an ingress rule</a></li><li><a href="#multiple-ingress-rules" class="table-of-contents__link toc-highlight">Multiple ingress rules</a></li><li><a href="#intelligent-connected-proxies" class="table-of-contents__link toc-highlight">Intelligent connected proxies</a></li></ul></li><li><a href="#lab-exercises" class="table-of-contents__link toc-highlight">Lab Exercises</a><ul><li><a href="#lab-111---service-mesh" class="table-of-contents__link toc-highlight">Lab 11.1 - Service mesh</a></li><li><a href="#lab-112---ingress-controller" class="table-of-contents__link toc-highlight">Lab 11.2 - Ingress controller</a></li></ul></li><li><a href="#knowledge-check" class="table-of-contents__link toc-highlight">Knowledge check</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/cka-prep/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/andrewdaoust/cka-prep" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Andrew D'Aoust. Built with Docusaurus.</div></div></div></footer></div>
<script src="/cka-prep/assets/js/runtime~main.0a33b008.js"></script>
<script src="/cka-prep/assets/js/main.5dd4e585.js"></script>
</body>
</html>